# ü§ñ –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π Studio App (Next.js 15) - –í–ï–†–°–ò–Ø 2.0
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã: next.config.js, PM2 –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ—Ä—Ç–æ–≤, –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: .\simple-deploy-v2.ps1 -ServerIP "157.180.87.32" -Username "deployuser"

param(
    [string]$ServerIP = "157.180.87.32",
    [string]$Username = "deployuser",
    [string]$DeployDir = "/var/www/studio-app",
    [string]$ArchiveName = "studio-deploy-simple-v2.tar.gz",
    [switch]$CleanServer = $false
)

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞
function Write-Log {
    param([string]$Message)
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" -ForegroundColor Green
}

function Write-Warning {
    param([string]$Message)
    Write-Host "[WARNING] $Message" -ForegroundColor Yellow
}

function Write-Error {
    param([string]$Message)
    Write-Host "[ERROR] $Message" -ForegroundColor Red
    exit 1
}

function Write-Step {
    param([string]$StepNumber, [string]$Description)
    Write-Host "`nüîÑ –≠–¢–ê–ü ${StepNumber}: $Description" -ForegroundColor Cyan
    Write-Host ("=" * 60) -ForegroundColor Cyan
}

Write-Host @"
üöÄ –£–ü–†–û–©–ï–ù–ù–´–ô –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –î–ï–ü–õ–û–ô STUDIO APP (Next.js 15) v2.0
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ –°–µ—Ä–≤–µ—Ä: $ServerIP
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $Username  
üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $DeployDir
üì¶ –ê—Ä—Ö–∏–≤: $ArchiveName
üßπ –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: $CleanServer
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
"@ -ForegroundColor Magenta

try {
    # –≠–¢–ê–ü 0: –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    if ($CleanServer) {
        Write-Step "0" "–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
        Write-Log "üßπ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
        
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        ssh "$Username@$ServerIP" "pm2 delete all 2>/dev/null || true"
        ssh "$Username@$ServerIP" "pm2 kill 2>/dev/null || true"
        
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 3000
        ssh "$Username@$ServerIP" "lsof -ti:3000 | xargs kill -9 2>/dev/null || true"
        
        # –û—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        ssh "$Username@$ServerIP" "rm -rf $DeployDir"
        ssh "$Username@$ServerIP" "mkdir -p $DeployDir"
        
        # –û—á–∏—Å—Ç–∫–∞ PM2 –ª–æ–≥–æ–≤
        ssh "$Username@$ServerIP" "pm2 flush 2>/dev/null || true"
        
        Write-Log "‚úÖ –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    }

    # –≠–¢–ê–ü 1: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ
    Write-Step "1" "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ"
    Write-Log "üì¶ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ npm run build..."
    
    $buildResult = & npm run build
    if ($LASTEXITCODE -ne 0) {
        throw "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞!"
    }
    Write-Log "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"

    # –≠–¢–ê–ü 2: –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
    Write-Step "2" "–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –¥–µ–ø–ª–æ—è"
    Write-Log "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ $ArchiveName..."
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∞—Ä—Ö–∏–≤ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (Test-Path $ArchiveName) {
        Remove-Item $ArchiveName -Force
    }
    
    # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
    $filesToArchive = @(
        ".next",
        "package.json", 
        "package-lock.json",
        "next.config.js",
        "src",
        "public"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    $existingFiles = @()
    foreach ($file in $filesToArchive) {
        if (Test-Path $file) {
            $existingFiles += $file
            Write-Log "‚úì –ù–∞–π–¥–µ–Ω: $file"
        } else {
            Write-Warning "‚ö† –ù–µ –Ω–∞–π–¥–µ–Ω: $file"
        }
    }
    
    if ($existingFiles.Count -eq 0) {
        throw "–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è!"
    }
    
    # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –∏—Å–ø–æ–ª—å–∑—É—è tar
    try {
        $tarCommand = "tar -czf `"$ArchiveName`" " + ($existingFiles -join " ")
        Invoke-Expression $tarCommand
        Write-Log "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é tar"
    }
    catch {
        Write-Warning "tar –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º PowerShell..."
        $zipName = $ArchiveName.Replace(".tar.gz", ".zip")
        Compress-Archive -Path $existingFiles -DestinationPath $zipName -Force
        $ArchiveName = $zipName
        Write-Log "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $ArchiveName"
    }

    # –≠–¢–ê–ü 3: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    Write-Step "3" "–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
    Write-Log "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ $ArchiveName –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
    
    & scp "$ArchiveName" "$Username@$ServerIP`:$DeployDir/"
    if ($LASTEXITCODE -ne 0) {
        throw "–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
    }
    Write-Log "‚úÖ –ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω"

    # –£–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤
    Remove-Item $ArchiveName -Force
    Write-Log "üßπ –õ–æ–∫–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω"

    # –≠–¢–ê–ü 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    Write-Step "4" "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    Write-Log "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è Node.js –∏ PM2..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js
    $nodeCheck = & ssh "$Username@$ServerIP" "node -v 2>/dev/null `|| echo 'NOT_FOUND'"
    if ($nodeCheck -eq "NOT_FOUND") {
        Write-Error "Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!"
    }
    Write-Log "‚úÖ Node.js –≤–µ—Ä—Å–∏—è: $nodeCheck"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2
    $pm2Check = & ssh "$Username@$ServerIP" "pm2 -v 2>/dev/null `|| echo 'NOT_FOUND'"
    if ($pm2Check -eq "NOT_FOUND") {
        Write-Log "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
        & ssh "$Username@$ServerIP" "npm install -g pm2"
    }
    Write-Log "‚úÖ PM2 –≥–æ—Ç–æ–≤"

    # –≠–¢–ê–ü 5: –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    Write-Step "5" "–î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Next.js 15"
    Write-Log "üöÄ –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –¥–µ–ø–ª–æ—è..."
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    Write-Log "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
    & ssh "$Username@$ServerIP" "pm2 delete all 2>/dev/null `|| true"
    & ssh "$Username@$ServerIP" "lsof -ti:3000 | xargs kill -9 2>/dev/null `|| true"
    Start-Sleep -Seconds 2

    # –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
    Write-Log "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞..."
    $backupDir = "/var/www/studio.backup.$(Get-Date -Format 'yyyyMMdd_HHmmss')"
    & ssh "$Username@$ServerIP" "if `[ -d '$DeployDir/.next' `] `|| `[ -f '$DeployDir/package.json' `]; then sudo mkdir -p '$backupDir' `&`& sudo cp -r '$DeployDir/.' '$backupDir/' 2>/dev/null `|| true; fi"

    # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞
    Write-Log "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞..."
    if ($ArchiveName.EndsWith(".zip")) {
        & ssh "$Username@$ServerIP" "cd $DeployDir `&`& unzip -o $ArchiveName"
    } else {
        & ssh "$Username@$ServerIP" "cd $DeployDir `&`& tar -xzf $ArchiveName"
    }
    & ssh "$Username@$ServerIP" "cd $DeployDir `&`& rm -f $ArchiveName"
    
    Write-Log "‚úÖ –ê—Ä—Ö–∏–≤ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω"

    # –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
    Write-Log "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    $envContent = @"
NODE_ENV=production
DATABASE_URL=postgresql://userstudio:userstudio@localhost:5432/userstudio
NEXTAUTH_URL=http://$ServerIP`:3000
NEXTAUTH_SECRET=your-secret-key-here

# Database configuration
DB_NAME=userstudio
DB_USERNAME=userstudio
DB_PASSWORD=userstudio
DB_HOST=localhost
DB_PORT=5432
DB_DIALECT=postgres
"@

    $envContent | & ssh "$Username@$ServerIP" "cat > $DeployDir/.env"
    Write-Log "‚úÖ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ next.config.js (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´)
    Write-Log "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ next.config.js..."
    $configExists = & ssh "$Username@$ServerIP" "test -f $DeployDir/next.config.js `&`& echo 'EXISTS' `|| echo 'NOT_FOUND'"

    if ($configExists -eq "NOT_FOUND") {
        Write-Log "‚ö†Ô∏è next.config.js –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º..."
        $configContent = @"
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  transpilePackages: ['sequelize'],
  experimental: {
    allowedDevOrigins: [
      "http://localhost:3000",
      "http://127.0.0.1:3000",
    ],
  },
};

export default nextConfig;
"@
        $configContent | ssh "$Username@$ServerIP" "cat > $DeployDir/next.config.js"
        Write-Log "‚úÖ next.config.js —Å–æ–∑–¥–∞–Ω"
    } else {
        Write-Log "‚úÖ next.config.js –Ω–∞–π–¥–µ–Ω"
    }

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    Write-Log "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    ssh "$Username@$ServerIP" "cd $DeployDir && npm install --production --legacy-peer-deps"
    Write-Log "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

    # –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    Write-Log "üóÉÔ∏è –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    $migrateExists = ssh "$Username@$ServerIP" "test -f $DeployDir/src/lib/migrate.ts && echo 'EXISTS' || echo 'NOT_FOUND'"
    if ($migrateExists -eq "EXISTS") {
        ssh "$Username@$ServerIP" "cd $DeployDir && npx tsx src/lib/migrate.ts || true"
        Write-Log "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
    } else {
        Write-Warning "‚ö†Ô∏è –§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω"
    }

    # –°–æ–∑–¥–∞–Ω–∏–µ PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï–ú)
    Write-Log "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    $pm2Config = @"
module.exports = {
  apps: [{
    name: 'studio-nextjs15',
    script: 'npm',
    args: 'start',
    cwd: '$DeployDir',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
"@

    $pm2Config | ssh "$Username@$ServerIP" "cat > $DeployDir/ecosystem.config.cjs"
    Write-Log "‚úÖ PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞"

    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2
    Write-Log "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Next.js 15)..."
    ssh "$Username@$ServerIP" "cd $DeployDir && pm2 start ecosystem.config.cjs"
    ssh "$Username@$ServerIP" "pm2 save"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    Write-Log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    Start-Sleep -Seconds 5
    ssh "$Username@$ServerIP" "pm2 status"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    Write-Log "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    $attempts = 0
    $maxAttempts = 10
    $appResponding = $false

    while ($attempts -lt $maxAttempts -and -not $appResponding) {
        $attempts++
        try {
            $response = ssh "$Username@$ServerIP" "curl -f http://localhost:3000 >/dev/null 2>&1 && echo 'OK' || echo 'FAIL'"
            if ($response -eq "OK") {
                Write-Log "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã"
                $appResponding = $true
            } else {
                Write-Log "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è... ($attempts/$maxAttempts)"
                Start-Sleep -Seconds 3
            }
        }
        catch {
            Write-Log "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è... ($attempts/$maxAttempts)"
            Start-Sleep -Seconds 3
        }
    }

    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
    Write-Log "üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤..."
    ssh "$Username@$ServerIP" "ls -dt /var/www/studio.backup.* 2>/dev/null | tail -n +4 | sudo xargs rm -rf || true"

    Write-Log "‚úÖ –î–µ–ø–ª–æ–π Next.js 15 –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

    # –≠–¢–ê–ü 6: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    Write-Step "6" "–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
    Write-Log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

    Start-Sleep -Seconds 5

    try {
        $response = Invoke-WebRequest -Uri "http://$ServerIP`:3000" -TimeoutSec 10 -UseBasicParsing
        if ($response.StatusCode -eq 200) {
            Write-Log "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã!"
        } else {
            Write-Warning "‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç —Å –∫–æ–¥–æ–º: $($response.StatusCode)"
        }
    }
    catch {
        Write-Warning "‚ö†Ô∏è –ù–µ —É–¥–∞–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $_"
    }

    Write-Host @"

üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üåê URL: http://$ServerIP`:3000
üìä –°—Ç–∞—Ç—É—Å: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ
üîß PM2: studio-nextjs15
üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $DeployDir
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
"@ -ForegroundColor Green

} catch {
    Write-Error "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: $_"
}
