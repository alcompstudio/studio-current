#!/bin/bash

# üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è Studio App (Next.js 14)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-nextjs14.sh [server_ip] [username]

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
    exit 1
}

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
SERVER_IP=${1:-"185.46.8.179"}
USERNAME=${2:-"alcompstudio"}
DEPLOY_DIR="/var/www/studio"
ARCHIVE_NAME="studio-deploy-nextjs14.tar.gz"

log "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Studio App (Next.js 14)"
log "–°–µ—Ä–≤–µ—Ä: $USERNAME@$SERVER_IP"
log "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $DEPLOY_DIR"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞—Ä—Ö–∏–≤–∞
if [ ! -f "$ARCHIVE_NAME" ]; then
    error "–ê—Ä—Ö–∏–≤ $ARCHIVE_NAME –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞."
fi

log "üì¶ –ê—Ä—Ö–∏–≤ –Ω–∞–π–¥–µ–Ω: $(ls -lh $ARCHIVE_NAME | awk '{print $5}')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
if ! ping -c 1 "$SERVER_IP" > /dev/null 2>&1; then
    warn "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
fi

# –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
log "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp "$ARCHIVE_NAME" "$USERNAME@$SERVER_IP:/tmp/" || error "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞"

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è
log "üîß –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh "$USERNAME@$SERVER_IP" << 'EOF'
set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[REMOTE] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[REMOTE WARNING] $1${NC}"
}

error() {
    echo -e "${RED}[REMOTE ERROR] $1${NC}"
    exit 1
}

DEPLOY_DIR="/var/www/studio"
ARCHIVE_NAME="studio-deploy.tar.gz"

log "üèóÔ∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–µ–ø–ª–æ—è (Next.js 14)..."

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
sudo mkdir -p "$DEPLOY_DIR"

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ
log "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sudo pkill -f "npm start" || true
sudo systemctl stop studio || true
pm2 stop studio || true

# –ë—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
if [ -d "$DEPLOY_DIR/.next" ]; then
    log "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
    sudo mv "$DEPLOY_DIR" "$DEPLOY_DIR.backup.nextjs14.$(date +%Y%m%d_%H%M%S)" || true
    sudo mkdir -p "$DEPLOY_DIR"
fi

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
log "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ (Next.js 14)..."
sudo tar -xzf "/tmp/$ARCHIVE_NAME" -C "$DEPLOY_DIR"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
log "üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
cd "$DEPLOY_DIR"
sudo npm ci --only=production

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
log "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
sudo chown -R www-data:www-data "$DEPLOY_DIR"
sudo chmod -R 755 "$DEPLOY_DIR"

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "$DEPLOY_DIR/.env" ]; then
    log "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    sudo cp "$DEPLOY_DIR/.env.example" "$DEPLOY_DIR/.env"
    warn "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ $DEPLOY_DIR/.env"
fi

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
log "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Next.js 14)..."

# –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ PM2
if command -v pm2 > /dev/null; then
    log "–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2..."
    cd "$DEPLOY_DIR"
    pm2 start npm --name "studio-nextjs14" -- start || warn "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ PM2"
    pm2 save || true
elif systemctl is-enabled studio > /dev/null 2>&1; then
    log "–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ systemd..."
    sudo systemctl start studio || warn "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ systemd"
else
    log "–ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ..."
    cd "$DEPLOY_DIR"
    nohup npm start > studio-nextjs14.log 2>&1 &
fi

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
log "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -f "/tmp/$ARCHIVE_NAME"

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
log "üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤..."
ls -dt /var/www/studio.backup.* 2>/dev/null | tail -n +4 | sudo xargs rm -rf || true

log "‚úÖ –î–µ–ø–ª–æ–π Next.js 14 –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
log "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://$(hostname -I | awk '{print $1}'):3000"
log "üìã –í–µ—Ä—Å–∏—è: Next.js 14.2.29 (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è)"

EOF

if [ $? -eq 0 ]; then
    log "‚úÖ –î–µ–ø–ª–æ–π Next.js 14 –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    log "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://$SERVER_IP:3000"
    log "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    echo "   1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ /var/www/studio/.env"
    echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
    echo "   3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
    echo "   4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
    echo ""
    echo "üîß –í–µ—Ä—Å–∏—è: Next.js 14.2.29 (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è)"
    echo "‚ö†Ô∏è  –û—Ç–ª–∏—á–∏—è –æ—Ç Next.js 15:"
    echo "   - –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å Sequelize"
    echo "   - –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å clientModules"
    echo "   - –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Node.js 18+"
else
    error "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
fi
