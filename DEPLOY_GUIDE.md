# Пошаговое руководство по развертыванию веб-приложения на Hetzner Cloud

Этот документ описывает шаги, предпринятые для развертывания веб-приложения (проект "studio") на сервере Hetzner Cloud.

## Раздел 1: Подготовка и создание сервера на Hetzner

### Шаг 1.1: Вход в Hetzner Cloud Console
*   **Инструкция:** Откройте браузер и перейдите на сайт Hetzner Cloud Console ([https://console.hetzner.cloud/](https://console.hetzner.cloud/)). Войдите в свой аккаунт.
*   **Статус:** Выполнен.
*   **Комментарии/Проблемы:** Ссылка на дашборд проекта: [https://console.hetzner.cloud/projects/10637332/dashboard](https://console.hetzner.cloud/projects/10637332/dashboard)

### Шаг 1.2: Создание нового сервера - Начало
*   **Инструкция:** В вашей консоли Hetzner Cloud найдите и нажмите кнопку для создания нового сервера (обычно это что-то вроде "Add Server", "Create Server" или значок "+").
*   **Статус:** Выполнен.
*   **Комментарии/Проблемы:** Перешли на страницу создания сервера: [https://console.hetzner.cloud/projects/10637332/servers/create](https://console.hetzner.cloud/projects/10637332/servers/create)

### Шаг 1.3: Выбор местоположения сервера (Location)
*   **Инструкция:** На странице создания сервера выберите местоположение (Location) для вашего сервера. Рекомендуется выбирать ближайшее к вам или вашей целевой аудитории (например, Falkenstein или Helsinki).
*   **Статус:** Выполнен.
*   **Выбранное местоположение:** Helsinki
*   **Комментарии/Проблемы:**

### Шаг 1.4: Выбор образа операционной системы (Image)
*   **Инструкция:** Выберите образ операционной системы. Рекомендую `Ubuntu` (например, последнюю доступную LTS-версию, такую как 22.04 или 24.04, если доступна).
*   **Статус:** Выполнен.
*   **Выбранный образ:** Ubuntu 24.04
*   **Комментарии/Проблемы:**

### Шаг 1.5: Выбор типа сервера (Type)
*   **Инструкция:** Выберите тип сервера. Для начала и тестирования подойдет один из стандартных или экономичных вариантов (например, CX11, CPX11 или аналогичный по характеристикам).
*   **Статус:** Выполнен.
*   **Выбранный тип:** CX22 (Shared vCPU, 2 Intel vCPUs, 4 GB RAM, 40 GB SSD, 20 TB Traffic)
*   **Комментарии/Проблемы:**

### Шаг 1.6: Добавление SSH-ключа (SSH Keys)
*   **Инструкция:** В разделе "SSH Keys" выберите существующий SSH-ключ или добавьте новый, вставив ваш **публичный** SSH-ключ.
*   **Статус:** Выполнен.
*   **Действие с SSH-ключом:** Добавлен новый SSH-ключ.
*   **Комментарии/Проблемы:**
    *   Ключ был сгенерирован на локальной машине (Windows) и добавлен в Hetzner.
    *   **Инструкция по генерации SSH-ключа (Windows PowerShell/CMD):**
        1.  Открыть PowerShell или Командную строку.
        2.  Выполнить команду: `ssh-keygen -t ed25519 -C "your_email@example.com"` (заменив email).
        3.  На запрос о файле нажать Enter (принять путь по умолчанию).
        4.  При запросе `Overwrite (y/n)?`, если файл существует и его нужно перезаписать, ввести `y` и Enter.
        5.  Ввести и подтвердить парольную фразу (рекомендуется) или оставить пустой для отсутствия парольной фразы.
        6.  Скопировать содержимое файла `C:\Users\ИМЯ_ПОЛЬЗОВАТЕЛЯ\.ssh\id_ed25519.pub` и вставить в панель Hetzner.

### Шаг 1.7: Настройка сети, томов, брандмауэров, бэкапов (Опционально)
*   **Инструкция:** Оставить по умолчанию на данном этапе.
*   **Статус:** Выполнен.
*   **Решение:** Оставлено по умолчанию.
*   **Комментарии/Проблемы:** Настройки сети, томов, брандмауэров Hetzner и бэкапов оставлены по умолчанию при создании сервера.

### Шаг 1.8: Имя сервера и завершение создания
*   **Инструкция:** Придумайте имя сервера, просмотрите конфигурацию и нажмите "Create & Buy Now".
*   **Статус:** Выполнен.
*   **Имя сервера:** studio-app-server
*   **IP-адрес сервера (после создания):** 157.180.87.32
*   **Комментарии/Проблемы:**

## Раздел 2: Первоначальная настройка сервера

### Шаг 2.1: Подключение к серверу по SSH
*   **Инструкция:** `ssh root@157.180.87.32`
*   **Статус:** Выполнен.
*   **Комментарии/Проблемы:**
    *   **Проблема:** При первой попытке подключения возникла ошибка `WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!`. Это произошло из-за наличия старой записи для IP `157.180.87.32` в файле `C:\Users\Admin/.ssh/known_hosts`.
    *   **Решение:** Удалить старую запись ключа хоста с помощью команды: `ssh-keygen -R 157.180.87.32`.
    *   **Результат:** Успешное подключение к `root@studio-app-server:~#`.

### Шаг 2.2: Обновление системы
*   **Инструкция:** `apt update && apt upgrade -y`
*   **Статус:** Выполнен.
*   **Комментарии/Проблемы:** Сервер перезагружен (`reboot`). Успешное повторное подключение.

### Шаг 2.3: (Рекомендация) Создание нового пользователя с sudo-правами
*   **Инструкция:** Создан пользователь `deployuser`, добавлен в группу `sudo`, SSH-ключ скопирован.
*   **Статус:** Выполнен.
*   **Результат:** Успешное подключение к серверу под `deployuser@157.180.87.32`.

## Раздел 3: Установка необходимого ПО (Node.js, PostgreSQL)

### Шаг 3.1: Установка Node.js и npm
*   **Инструкция:** Установлена Node.js v20.x (LTS).
*   **Статус:** Выполнен.
*   **Версия Node.js:** v20.19.1, **npm:** 10.8.2.

### Шаг 3.2: Установка PostgreSQL
*   **Инструкция:** Установлен PostgreSQL.
*   **Статус:** Выполнен.
*   **Комментарии/Проблемы:** Сервер PostgreSQL (кластер 16-main) успешно запущен.

### Шаг 3.3: Настройка пользователя и базы данных в PostgreSQL
*   **Инструкция:** Создан пользователь `userstudio` с паролем `userstudio` и база данных `userstudio`.
*   **Статус:** Выполнен.

## Раздел 4: Загрузка и настройка вашего приложения

### Шаг 4.1: Сборка проекта локально
*   **Инструкция:** `npm run build` на локальной машине.
*   **Статус:** Выполнен (с предупреждениями).
*   **Комментарии/Проблемы:** Предупреждение об импорте `Order` (функционал заказов не готов).

### Шаг 4.2: Архивирование проекта локально
*   **Инструкция:** Проект заархивирован в `studio_app.tar.gz`.
*   **Статус:** Выполнен.

### Шаг 4.3: Копирование архива на сервер
*   **Инструкция:** Архив скопирован на сервер.
*   **Статус:** Выполнен.

### Шаг 4.4: Создание директории для приложения и распаковка на сервере
*   **Инструкция:** Файлы проекта распакованы в `/var/www/studio_app`.
*   **Статус:** Выполнен.

### Шаг 4.5: Установка зависимостей на сервере
*   **Инструкция:** `npm install --production` на сервере (позже заменено на `npm install`).
*   **Статус:** Выполнен.
*   **Комментарии/Проблемы:** Установка прошла успешно.

### Шаг 4.6: Создание и настройка файла `.env` на сервере
*   **Инструкция:** Файл `.env` создан и заполнен переменными (включая `DB_NAME`, `DB_USERNAME`, `DB_PASSWORD`, `DB_HOST`).
*   **Статус:** Выполнен.

### Шаг 4.7: Запуск миграций базы данных
*   **Инструкция:**
    1.  На **сервере**, в директории вашего приложения (`/var/www/studio_app`), выполнена команда сборки:
        ```bash
        npm run build
        ```
        *   **Результат:** Сборка успешно завершена (`✓ Compiled successfully`) с ожидаемыми предупреждениями по `Order` и Sequelize.
    2.  Попытка запуска скомпилированного скрипта миграций:
        *   **Команда для поиска:** `grep -r '[MIGRATE_SCRIPT_START]' .next/server --include '*.js'`
        *   **Результат поиска:** Строка найдена в файле `.next/server/chunks/56.js`.
        *   **Команда запуска:** `node .next/server/chunks/56.js`
        *   **Результат запуска:** Команда не вывела ничего в консоль.
    3.  Альтернативная попытка запуска миграций с помощью `tsx`:
        *   **Команда:** `npx tsx src/lib/migrate.ts`
        *   **Результат:** Миграции успешно выполнены. Логи: `[MIGRATE_SCRIPT_START] ... [MIGRATE_SCRIPT_COMPLETE] All migrations completed successfully ... [MIGRATE_SCRIPT_EXIT]`.
*   **Статус:** Миграции базы данных успешно выполнены.
*   **Используемая команда миграции:** `npx tsx src/lib/migrate.ts`
*   **Комментарии/Проблемы:**
    *   Запуск `node .next/server/chunks/56.js` не дал ожидаемого вывода.
    *   Запуск `npx tsx src/lib/migrate.ts` прошел успешно.
    *   **Следующее действие:** Переход к Разделу 5.

## Раздел 5: Запуск приложения и настройка Firewall

### Шаг 5.1: Установка и запуск приложения с помощью `pm2`
*   **Инструкция:**
    1.  Установлен `pm2` глобально: `sudo npm install pm2 -g`
    2.  Переход в директорию приложения: `cd /var/www/studio_app` (выполнено ранее)
    3.  Приложение запущено: `pm2 start npm --name "studio-app" -- run start`
    4.  Настроен автозапуск `pm2`: `pm2 startup` (и выполнена выведенная команда `sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u deployuser --hp /home/deployuser`)
    5.  Список процессов сохранен: `pm2 save`
*   **Статус:** Выполнен.
*   **Статус приложения в pm2:** `online` (id: 0, name: studio-app, mode: fork, status: online, cpu: 0%, memory: 56.2mb)
*   **Комментарии/Проблемы:** Приложение успешно запущено под управлением `pm2`.

### Шаг 5.2: Настройка брандмауэра `ufw`
*   **Инструкция:**
    ```bash
    sudo ufw allow ssh
    sudo ufw allow 3000/tcp
    sudo ufw enable
    sudo ufw status
    ```
*   **Статус:** Выполнен.
*   **Статус ufw:** `active`. Разрешены порты 22/tcp и 3000/tcp (v4 и v6).
*   **Комментарии/Проблемы:** Брандмауэр настроен.

### Шаг 5.3: Проверка доступности приложения
*   **Инструкция:** Открыть в браузере `http://157.180.87.32:3000`.
*   **Статус:** Выполнен.
*   **Результат проверки:** Приложение успешно запущено и доступно. Основной функционал (создание/редактирование данных) работает корректно.
*   **Комментарии/Проблемы:** Нет.

## Дополнительные заметки и решения проблем

(Здесь будем добавлять информацию по мере возникновения специфических ситуаций)
